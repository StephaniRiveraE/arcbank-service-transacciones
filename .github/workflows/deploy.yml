# ============================================================================
# WORKFLOW DE DEPLOY - arcbank-service-transacciones (PostgreSQL)
# Copia este archivo a: .github/workflows/deploy-eks-transacciones.yml
# en el repositorio de arcbank-service-transacciones
# ============================================================================
name: "Deploy arcbank-service-transacciones to EKS"

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-2
  EKS_CLUSTER: eks-banca-ecosistema
  NAMESPACE: arcbank
  ECR_REPO: arcbank-service-transacciones
  SERVICE_NAME: service-transacciones
  CONTAINER_PORT: "8080"
  SECRET_NAME: "arcbank-db-credentials"
  SECRET_KEY_URL: "transacciones-url"
  SECRET_KEY_USER: "username"
  SECRET_KEY_PASS: "password"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      
      - name: Build with Maven
        run: mvn clean package -DskipTests
      
      - name: Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login a ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build y Push imagen
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG .
          docker push $ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG
          echo "IMAGE=$ECR_REGISTRY/${{ env.ECR_REPO }}:$IMAGE_TAG" >> $GITHUB_ENV
      
      - name: Configurar kubectl
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}
      
      - name: Verificar o Crear Deployment
        run: |
          if kubectl get deployment ${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }} > /dev/null 2>&1; then
            echo "âœ… Deployment existe, actualizando imagen..."
            kubectl set image deployment/${{ env.SERVICE_NAME }} \
              ${{ env.SERVICE_NAME }}=${{ env.IMAGE }} \
              -n ${{ env.NAMESPACE }}
          else
            echo "ðŸ“¦ Deployment no existe, creando..."
            cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: ${{ env.SERVICE_NAME }}
              bank: ${{ env.NAMESPACE }}
          spec:
            replicas: 1
            strategy:
              type: Recreate
            selector:
              matchLabels:
                app: ${{ env.SERVICE_NAME }}
            template:
              metadata:
                labels:
                  app: ${{ env.SERVICE_NAME }}
                  bank: ${{ env.NAMESPACE }}
              spec:
                containers:
                  - name: ${{ env.SERVICE_NAME }}
                    image: ${{ env.IMAGE }}
                    ports:
                      - containerPort: ${{ env.CONTAINER_PORT }}
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "250m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                    env:
                      - name: SPRING_PROFILES_ACTIVE
                        value: "prod"
                      - name: SPRING_DATASOURCE_URL
                        valueFrom:
                          secretKeyRef:
                            name: ${{ env.SECRET_NAME }}
                            key: ${{ env.SECRET_KEY_URL }}
                      - name: SPRING_DATASOURCE_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: ${{ env.SECRET_NAME }}
                            key: ${{ env.SECRET_KEY_USER }}
                      - name: SPRING_DATASOURCE_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: ${{ env.SECRET_NAME }}
                            key: ${{ env.SECRET_KEY_PASS }}
                      - name: SPRING_FLYWAY_BASELINE_ON_MIGRATE
                        value: "false"
                      - name: APIM_ENDPOINT
                        value: "http://switch-ms-nucleo.switch.svc.cluster.local"
                      - name: COGNITO_CLIENT_ID
                        value: "3jprfuk1phejsm0sjr8p50n91e"
                      - name: COGNITO_CLIENT_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: "arcbank-cognito-credentials"
                            key: "client-secret"
                      - name: COGNITO_DOMAIN
                        value: "https://auth-banca-digiconecu-dev-lhd4go.auth.us-east-2.amazoncognito.com"
                      - name: COGNITO_SCOPE
                        value: "https://switch-api.com/transfers.write"
                      - name: SPRING_RABBITMQ_HOST
                        value: "b-455e546c-be71-4fe2-ba0f-bd3112e6c220.mq.us-east-2.on.aws"
                      - name: SPRING_RABBITMQ_PORT
                        value: "5671"
                      - name: SPRING_RABBITMQ_USERNAME
                        value: "arcbank"
                      - name: SPRING_RABBITMQ_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: "arcbank-rabbitmq-credentials"
                            key: "password"
                      - name: SPRING_RABBITMQ_SSL_ENABLED
                        value: "true"
                    livenessProbe:
                      httpGet:
                        path: /actuator/health/liveness
                        port: ${{ env.CONTAINER_PORT }}
                      initialDelaySeconds: 120
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 5
                    readinessProbe:
                      httpGet:
                        path: /actuator/health/readiness
                        port: ${{ env.CONTAINER_PORT }}
                      initialDelaySeconds: 180
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 10
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 80
                targetPort: ${{ env.CONTAINER_PORT }}
            selector:
              app: ${{ env.SERVICE_NAME }}
          EOF
          fi
      
      - name: Esperar Rollout
        run: |
          echo "â³ Esperando que el deployment estÃ© listo..."
          kubectl rollout status deployment/${{ env.SERVICE_NAME }} \
            -n ${{ env.NAMESPACE }} --timeout=300s
          
          echo "âœ… Deploy completado!"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }}

      - name: Reporte de Error (si falla)
        if: failure()
        run: |
          echo "âŒ EL DESPLIEGUE FALLÃ“ - REPORTE DE ERRORES:"
          echo "=========================================="
          echo "1. ESTADO DE LOS PODS:"
          kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }} -o wide
          echo ""
          echo "2. EVENTOS RECIENTES:"
          kubectl describe pod -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }} | tail -20
          echo ""
          echo "3. LOGS DE APLICACIÃ“N:"
          kubectl logs -n ${{ env.NAMESPACE }} -l app=${{ env.SERVICE_NAME }} --tail=50
